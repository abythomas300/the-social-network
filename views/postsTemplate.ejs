<!DOCTYPE html>
<html lang="en">
<%- include('partials/_head') %>
<style>


    .blog-container {
        padding: 2rem 0;
    }

    .blog-image {
        /* Ensures the image fills its container and is responsive */
        width: 100%;
        height: auto;
        max-height: 500px; /* Optional: Set a max height for larger screens */
        object-fit: cover; /* Ensures the image aspect ratio is maintained and it covers the space */
        border-radius: 8px; /* Optional: Add rounded corners to the image */
    }
    
    .blog-content {
        padding: 2rem;
    }

    /* Add custom spacing between the columns on large screens */
    @media (min-width: 992px) {
        .blog-image-col {
            padding-right: 1rem;
        }
        .blog-text-col {
            padding-left: 1rem;
        }
    }

    .button-section {
        display: flex;
        gap: 0.5rem; /* Adds space between the buttons */
        flex-wrap: wrap; /* Allows buttons to wrap to the next line on small screens */
        margin-top: 2rem;
    }

    .comment-box {
        border: 1px solid #dee2e6;
    }

</style>
<body>


    <!-- Helper function to convert date from YYYY-MM-DD to DD-MM-YYYY -->
    <% function dateConversion(dateInYMD){
        const parts = dateInYMD.split('-')
        const dateInDMY = `${parts[2]}-${parts[1]}-${parts[0]}`
        return dateInDMY;
    }%>


    <%if(data.message.length > 0) {%>

        <div class="toast-container position-fixed bottom-0 end-0 p-3">
          <div id="liveToast" class="toast" role="alert" >
            <div class="toast-body bg-success bg-gradient text-white">
              <%=data.message%>
            </div>
          </div>
        </div>

    <%}%>

    <%- include('partials/_header') %>
    
    <%- include('partials/_navbar') %>

    

    <!--Template for displaying all blog posts -->
    
    <%if(data.blogs.length > 0) {%>

            <%data.blogs.forEach(function(blog){%>
                    
                <div class="container blog-container">
                    <div class="row">
                
                        <!-- Image column -->
                        <div class="col-lg-6 blog-image-col mt-5">
                            <img src="/uploads/<%=blog.thumbnail%>" alt="<%= blog.title %>" class="img-fluid blog-image">
                        </div>
                
                        <!-- Text content column -->
                        <div class="col-lg-6 blog-text-col">
                            <div class="blog-content">
                                <h1 class="display-5 fw-bold lh-2"><%= blog.title %></h1>
                                <p class="lead mt-4"><%= blog.content %></p>
                                <div class="d-flex align-items-center">
                                    <img src="https://avatar.iran.liara.run/username?username=<%=blog.author.username%>" alt="profile picture" width="30" height="30">
                                    <p class="text-muted large mt-3 ms-2">Posted by <span class="fst-italic fw-semibold mx-1"> <%= blog.author.username %> </span> on <%= dateConversion(blog.createdAt.toISOString().substring(0,10))%> </p>
                                </div>
                                <!-- Option Buttons -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Buttons section -->
                    <div class="button-section">
                        <button class="btn btn-outline-primary btn-sm likeButton" onclick="likeHandler('<%=blog._id%>')"><i class="bi bi-heart"></i><span style="font-style: normal; font-size: large;"> <%= blog.likes.length %> </span></button>
                        <button class="btn btn-outline-primary btn-sm" onclick="toggleCommentSection('comments-<%=blog._id%>')"><i class="bi bi-chat-left-dots"></i><span style="font-style: normal; font-size: large;"> <%=blog.comments.length%></span></button>

                        <!-- Checking whether author of a blog is logged in  -->
                        <%if(data.currentUser.userId === blog.author._id.toString()){%>
                            <a href="/post/editBlog/<%=blog._id%>"><button class="btn btn-outline-primary btn-md"><i class="bi bi-pencil-square"></i></button></a>
                            <button class="btn btn-outline-primary btn-md" onclick="submitDeleteForm('<%=blog._id%>')"><i class="bi bi-trash3"></i></button>
                        <%}%>

                    </div>

                    <!-- Comments Section -->
                    <div class="comments-section mt-4" id="comments-<%=blog._id%>" style="display: none;">

                        <div style="max-width: 70%;">
                            <!-- Comments heading -->
                            <h5 class="fw-bold mb-3">Comments</h5>
                            
                            <!-- Displaying each comment inside this blog -->
                            <%if(blog.comments.length > 0){%>

                                <%blog.comments.forEach(function(comment){%>

                                    <div class="comment-box p-3 mb-2 rounded shadow-sm bg-light">
                                        <div class="d-flex align-items-center justify-content-start">
                                            <% // User Profile Picture %>
                                             <img src="https://avatar.iran.liara.run/username?username=<%=comment.commentAuthor.username%>" class="rounded-circle" width="40" height="40">
                                             <div class="d-flex align-items-center justify-content-start">
                                                <span class="fw-bold mx-2"><%=comment.commentAuthor.username%></span><span class="text-muted"><%=dateConversion(comment.createdAt.toISOString().substring(0,10))%> at <%=comment.createdAt.toISOString().substring(11,16)%> </span>
                                             </div>
                                        </div>
                                        <% // Comment Content %>
                                        <div class="mt-0">
                                            <p class="mt-2"><%=comment.content%></p>
                                        </div>
                                    </div>

                                <%})%>

                            <%}else{%>

                                <p class="text-muted fst-italic">No comments yet. Be the first to comment!</p>
                                
                            <%}%>

                        </div>

                    </div>

                    <!-- Comment Input Form -->
                     <form action="/post/comment/<%=blog._id%>" method="post" class="mt-4">
                        <div class="d-flex align-items-start" style="max-width: 70%;">
                            <!-- user profile picture -->
                            <img src="https://avatar.iran.liara.run/username?username=<%=data.currentUser.username%>" alt="Profile Picture" class="rounded-circle me-3" width="40" height="40">
                            <!-- Input -->
                            <div class="flex-grow-1">
                                <textarea name="comment" rows="2" class="form-control mb-3" placeholder="Write something..." required></textarea>
                                <button type="submit" class="btn btn-primary btn-md">Comment</button>
                            </div>
                        </div>
                     </form>



                </div>             

            <hr class="hr">

            <%})%>

    <%} else {%>

        <div class="container my-5">
            <h4 class="display-4 text-center mb-4">No new posts for now</h4>
        </div>

    <%}%>
    

    <%- include('partials/_footer') %>


    <!-- Delete Blog Form -->
    <form action="" method="POST" id="blogDeleteForm"></form>  <!-- action URL will be set in the submitDeleteForm() method -->
    

    <!-- SCRIPTS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    // initializing BS Toast component
    document.addEventListener('DOMContentLoaded', function() {
    var toastElement = document.getElementById('liveToast');
    if (toastElement) {
      var toast = new bootstrap.Toast(toastElement); // Calling BS toast function
      toast.show(); 

      // Hide toast after 3 seconds 
      setTimeout(function() {
        toast.hide();
      }, 3000);
     }
    });


    // method to toggle comment section
    function toggleCommentSection(sectionId) {
        const commentSection = document.getElementById(sectionId)
        if(commentSection.style.display === 'none') {
            commentSection.style.display = 'block'
        } else {
            commentSection.style.display = 'none'
        }
    }


    // method to submit the blog delete form
    function submitDeleteForm(blogId){
        console.log("ID of the blog passed to submitDeleteFrom() method: ", blogId)
        const blogDeleteForm = document.getElementById('blogDeleteForm')
        blogDeleteForm.action = `/post/${blogId}?_method=DELETE` 
        blogDeleteForm.submit()
    }


    // handling the like  request mannually using fetch() to avoid page reload when clicking on like button
    async function likeHandler(blogId){
        console.log("Blog Like Request Detected")
        console.log("Blog Id Passed: ", blogId)
        likeURL = `/post/like/${blogId}`
        console.log("POST Request URL: ", likeURL)
        console.log("Sending a post request to the server (without any payload)")

        try{
            
            const response = await fetch(likeURL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
                // we are not sending any payload to server, so no need to specify body:{} field
            })
            if(response.ok) {
                console.log("Post liked Successfully without any errors!")
            } else {
                console.log("Error in response from server")
            }

        }
        catch(error){
            console.error("Like opearation failed, reason:", error)
        }
    }
    </script>

</body>
</html>