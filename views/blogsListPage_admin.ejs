<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Blogs Info</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">

    <style>
        /* truncate content in layout 1 */
        .content-preview {
          display: -webkit-box;
          -webkit-line-clamp: 2;
          line-clamp: 2;
          -webkit-box-orient: vertical;
          overflow: hidden;
          text-overflow: ellipsis;
        }

        /* smooth expand/collapse animation */
        .layout-2, .layout-1 {
          overflow: hidden;
          max-height: 0;
          opacity: 0;
          transition: all 0.8s ease;
        }
        .layout-active {
          max-height: 2000px; /* big enough to hold content */
          opacity: 1;
        }

        /* collapse button right aligned */
        .button-section {
          display: flex;
          justify-content: space-between;
          align-items: center;
        }
        .button-section .collapse-btn {
          margin-left: auto;
        }
        .card-img-container{
            height: 300px;         /* for fixed height*/
            overflow: hidden;      /* to keep the cards parts from overflowed above other */
        }
        .card-img-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;     /* to keep image in a fixed ratio - irrespective of the image dimention */
        }

        .comment-box {
          border: 1px solid #dee2e6;
        }

        @media (max-width: 600px) {
          .comment-box{
            width: 100%;
          }
        }
        @media (min-width: 601px) {
          .comment-box {
            width: 75%;
          }
        }

    </style>
</head>


<body>

    <!-- Helper method to convert date from YYYY-MM-DD to DD-MM-YYYY -->
    <%
        function dateConversion(dateInYMD){
            const parts = dateInYMD.split('-')
            const dateInDMY = `${parts[2]}-${parts[1]}-${parts[0]}`
            return dateInDMY;
        }
    %>

    <!-- flash messages -->
    <% // For success flash messages %>
    <%if(flashMessages.success && flashMessages.success.length > 0) {%>
      <div class="toast-container position-fixed bottom-0 end-0 mx-4 my-2">
          <div id="liveToast" class="toast p-0 my-2" role="alert" >
            <div class="toast-body bg-success bg-gradient text-white fw-semibold ">
              <%=flashMessages.success%>
            </div>
          </div>
      </div>
    <%}%>


    <!-- Header - imported from /partials -->
    <%- include('partials/_header_admin') %>

    <!-- Navbar - imported from /partials -->
    <%- include('partials/_navbar_admin')%>

    
    <!-- Cards showing stats-->
    <div class="container my-5 ">
        <div class="row g-3 d-flex justify-content-between">
      
          <!-- Card showing number of blogs published -->
          <div class="col-12 col-md-6 col-lg-4 ">
            <div class="card h-100">
              <div class="card-img-container">
                <img src="/images/card-image-placard.png" 
                     class="card-img-top" alt="Total Blogs Published">
              </div>
              <div class="card-body">
                <h5 class="card-title">Ideas Published</h5>
                <p class="card-text fw-bold fs-2 text-danger"><%=data.blogsCount%></p>
              </div>
            </div>
          </div>
      
          <!-- Card showing number of users registered -->
          <div class="col-12 col-md-6 col-lg-4">
            <div class="card h-100">
              <div class="card-img-container">
                <img src="/images/card-image-crowd-red-bg.png" 
                     class="card-img-top" alt="Total Users Registered">
              </div>
              <div class="card-body">
                <h5 class="card-title">Happy Bloggers</h5>
                <p class="card-text fw-bold fs-2 text-danger"><%=data.usersCount%></p>
              </div>
            </div>
          </div>
      
        </div>
    </div>
      


    <% if(data.blogs.length > 0) { %>

        <% data.blogs.forEach(function(blog){ %>
            
            <div class="container my-4 blog-item">

                <!-- LAYOUT 1 (Preview) -->
                <div class="card mb-3 shadow-sm layout-1 layout-active">
                  <div class="row g-0 align-items-center">
                    <!-- Thumbnail -->
                    <div class="col-md-3">
                      <img src="/uploads/<%= blog.thumbnail %>" 
                           class="img-fluid rounded-start" 
                           alt="<%= blog.title %>">
                    </div>
                    <!-- Blog Info -->
                    <div class="col-md-8 p-0">
                      <div class="card-body">
                        <h5 class="display-6 fs-3 fw-bold lh-2"><%= blog.title %></h5>
                        <p class="card-text content-preview lead">
                          <%= blog.content %>
                        </p>
                        <small class="text-muted">Posted by <span class="fst-italic fw-semibold mx-1"> <%= blog.author.username %> </span> on <%= dateConversion(blog.createdAt.toISOString().substring(0,10)) %> </small>
                      </div>
                    </div>
                    <!-- Expand Button -->
                    <div class="col-md-1 text-end pe-3">
                      <button class="btn btn-outline-danger btn-sm expand-btn"><i class="bi bi-arrow-down-square-fill text-danger h5"></i></button>
                    </div>
                  </div>
                </div>
              
                <!-- LAYOUT 2 (Full) -->
                <div class="container blog-container layout-2">
                  <div class="row">
                  
                    <!-- Image column -->
                    <div class="col-lg-6 blog-image-col mt-3">
                      <img src="/uploads/<%=blog.thumbnail%>" 
                           alt="<%= blog.title %>" 
                           class="img-fluid blog-image">
                    </div>
                    
                    <!-- Text content column -->
                    <div class="col-lg-6 blog-text-col">
                      <div class="blog-content">
                        <h1 class="display-5 fw-bold lh-2"><%= blog.title %></h1>
                        <p class="lead mt-4"><%= blog.content %></p>
                        <p class="text-muted medium mt-4">
                          Posted by <span class="fst-italic fw-semibold mx-1"> 
                            <%= blog.author.username %> 
                          </span> 
                          on <%= dateConversion(blog.createdAt.toISOString().substring(0,10)) %>
                        </p>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Buttons -->
                  <div class="button-section mt-3">
                    <div>
                      <button class="btn btn-outline-danger btn-sm">
                        <i class="bi bi-heart "></i>
                        <span style="font-style: normal; font-size: large;"> <%=blog.likes.length%></span>
                      </button>
                      <button class="btn btn-outline-danger btn-sm" onclick="toggleCommentSection('comments-<%=blog._id%>')">
                        <i class="bi bi-chat-left-dots"></i>
                        <span style="font-style: normal; font-size: large;"> <%=blog.comments.length%></span>
                      </button>
                      <a href="/admin/editBlog/<%=blog._id%>">
                        <button class="btn btn-outline-danger btn-md">
                        <i class="bi bi-pencil-square text-danger"></i>
                      </a>
                      </button>
                      <button class="btn btn-outline-danger btn-md" onclick="submitDeleteForm('<%=blog._id%>')">
                        <i class="bi bi-trash3"></i>
                      </button>
                    </div>
                    
                    <!-- Collapse button at right -->
                    <button class="btn btn-outline-danger collapse-btn"><i class="bi bi-arrow-up-square-fill text-danger h5"></i></button>
                  </div>



                <!-- Comment Section -->
                <div class="comments-section mt-4" id="comments-<%=blog._id%>" style="display: none;">

                  <div class="comment-box-wrapper">
                      <!-- Comments heading -->
                      <h5 class="fw-bold mb-3">Comments</h5>
                      
                      <!-- Displaying each comment inside this blog -->
                      <%if(blog.comments.length > 0){%>

                          <%blog.comments.forEach(function(comment){%>

                              <!-- Comment Card -->
                              <div class="comment-card comment-box p-3 mb-2 rounded-5 shadow-sm bg-light">
                                <div class="comment-card-header d-flex align-items-center justify-content-between">
                                  <div class="comment-metadata d-flex ">
                                    <div class="metadata-content d-flex">
                                      <%// checking whether user exists%>
                                      <%if(comment.commentAuthor) {%>
                                        <img src="https://avatar.iran.liara.run/username?username=<%=comment.commentAuthor.username%>" class="rounded-circle" width="40" height="40">
                                        <span class="fw-bold mx-2"><%=comment.commentAuthor.username%></span><span class="text-muted"><%=dateConversion(comment.createdAt.toISOString().substring(0,10))%> at <%=comment.createdAt.toISOString().substring(11,16)%> </span>
                                      <%} else {%>
                                        <img src="/images/no_profile_picture_placeholder.png" class="rounded-circle" width="40" height="40">
                                        <span class="fw-bold fst-italic mx-2">Deleted User</span><span class="text-muted"><%=dateConversion(comment.createdAt.toISOString().substring(0,10))%> at <%=comment.createdAt.toISOString().substring(11,16)%> </span>  
                                      <%}%>
                                    </div>
                                  </div>
                                  <div class="comment-delete-button d-flex align-items-center">
                                    <form action="/admin/deleteComment/<%=blog._id%>?_method=DELETE" method="post">
                                      <input type="text" name=commentId value="<%=comment._id%>"  style="display: none;">
                                      <button type="submit" class="btn btn-md"><i class="bi bi-trash3 comment-delete-icon" style="color: #6c757d;"></i></button>
                                    </form>
                                  </div>
                                </div>
                                <div class="comment-body">
                                  <p class="mt-2"><%=comment.content%></p>
                                </div>
                                
                              </div>


                          <%})%>

                      <%}else{%>

                          <p class="text-muted fst-italic">No comments yet. </p>
                          
                      <%}%>

                  </div>

                </div>


                  <hr>
                </div>
              
              </div>

        <% }) %>
    <% } %>

    <!-- Form to delete a blog(action is defined in a saperate method in script) -->
    <form action="" method="POST" id="blogDeleteForm"></form>

    <script>

        // initializing BS Toast component
        document.addEventListener('DOMContentLoaded', function() {
          var toastElement = document.getElementById('liveToast');
          if (toastElement) {
            var toast = new bootstrap.Toast(toastElement); // Calling BS toast function
            toast.show(); 

            // Hide toast after 3 seconds 
            setTimeout(function() {
             toast.hide();
            }, 3000);
           }
         });


        // method to submit the delete blog form
        function submitDeleteForm(blogId){
          const blogDeleteForm = document.getElementById('blogDeleteForm')
          blogDeleteForm.action = `/post/${blogId}?_method=DELETE`  // setting form action URL (method overriding included)
          blogDeleteForm.submit()
        }

        
        // Expand button
        document.querySelectorAll(".expand-btn").forEach(btn => {
          btn.addEventListener("click", function() {
            const blogItem = btn.closest(".blog-item");
            blogItem.querySelector(".layout-1").classList.remove("layout-active");
            blogItem.querySelector(".layout-2").classList.add("layout-active");
          });
        });
    

        // Collapse button
        document.querySelectorAll(".collapse-btn").forEach(btn => {
          btn.addEventListener("click", function() {
            const blogItem = btn.closest(".blog-item");
            blogItem.querySelector(".layout-2").classList.remove("layout-active");
            blogItem.querySelector(".layout-1").classList.add("layout-active");
          });
        });


        // method to toggle comment section
        function toggleCommentSection(sectionId) {
            const commentSection = document.getElementById(sectionId)
            if(commentSection.style.display === 'none') {
              console.log("comment section is hidden")
                commentSection.style.display = 'block'
            } else {
              console.log("comment section is NOT hidden")
                commentSection.style.display = 'none'
            }
        }

        // changing delete button color on mouse hover
        const commentDeleteButton = document.querySelectorAll('.comment-delete-icon')
        console.log("delete button node list: ", commentDeleteButton)
        commentDeleteButton.forEach(function(dltButton){
          dltButton.addEventListener('mouseover', function(e){
            // dltButton.classList.add('text-danger')
            // dltButton.classList.remove('text-muted')
            dltButton.style.color = 'red'
          })
          dltButton.addEventListener('mouseout', function(e){
            // dltButtonc.classList.remove('text-danger')
            // dltButtonc.classList.add('text-muted')
            dltButton.style.color = '#6c757d'
          })
        })

    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js" integrity="sha384-ndDqU0Gzau9qJ1lfW4pNLlhNTkCfHzAVBReH9diLvGRem5+R9g2FzA8ZGN954O5Q" crossorigin="anonymous"></script>

</body>
</html>
